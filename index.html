<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏≤‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style> 
        /* ... CSS ‡πÄ‡∏î‡∏¥‡∏° ... */
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div id="main-app">
        <div class="max-w-7xl mx-auto">
            <div class="mb-6 bg-white p-4 rounded-lg shadow-md flex flex-wrap gap-4">
                <button id="add-tool-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</button>
                <button id="checkout-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">üìã ‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</button>
                <button id="repair-btn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg">üîß ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
                <button id="manage-users-btn" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-semibold text-gray-700 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                 <div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="p-3 text-left">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th><th class="p-3 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th class="p-3 text-left">S/N</th><th class="p-3 text-left">‡πÅ‡∏ú‡∏ô‡∏Å</th><th class="p-3 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th class="p-3 text-left">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody id="main-tool-table" class="divide-y divide-gray-200"></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-semibold mb-4">‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h2>
            <form id="checkout-form" class="space-y-4">
                <div><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô):</label><select id="checkout-tool-select" required class="mt-1 block w-full border p-2 rounded"></select></div>
                <div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ö‡∏¥‡∏Å:</label><input type="text" id="borrower-name" required class="mt-1 block w-full border p-2 rounded"></div>
                <div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢:</label><input type="text" id="lender-name" required class="mt-1 block w-full border p-2 rounded"></div>
                <div class="flex gap-4 pt-4"><button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå</button><button type="button" class="close-modal-btn w-full bg-gray-300 py-2 px-4 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
            </form>
        </div>
    </div>

    <div id="repair-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-semibold mb-4">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h2>
            <form id="repair-form" class="space-y-4">
                <div><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°:</label><select id="repair-tool-select" required class="mt-1 block w-full border p-2 rounded"></select></div>
                <div><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</label><input type="text" id="reporter-name" required class="mt-1 block w-full border p-2 rounded"></div>
                <div><label>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î:</label><textarea id="problem-description" rows="3" required class="mt-1 block w-full border p-2 rounded"></textarea></div>
                <div class="flex gap-4 pt-4"><button type="submit" class="w-full bg-orange-500 text-white py-2 px-4 rounded">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå</button><button type="button" class="close-modal-btn w-full bg-gray-300 py-2 px-4 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>
            </form>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        // ... (Supabase client setup)

        // --- DOM Elements ---
        const checkoutModal = document.getElementById('checkout-modal');
        const repairModal = document.getElementById('repair-modal');
        // ... (DOM elements ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)

        // --- Event Listeners ---
        // ... (Event Listeners ‡πÄ‡∏î‡∏¥‡∏°)
        document.getElementById('checkout-btn').addEventListener('click', async () => {
            await populateCheckoutTools();
            openModal(checkoutModal);
        });
        document.getElementById('repair-btn').addEventListener('click', async () => {
            await populateRepairTools();
            openModal(repairModal);
        });

        // --- Checkout & Repair ---
        async function populateCheckoutTools() {
            const select = document.getElementById('checkout-tool-select');
            const { data: tools } = await supabase.from('tools').select('*').eq('status', '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
            select.innerHTML = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ --</option>';
            if(tools) tools.forEach(t => select.innerHTML += `<option value="${t.id}" data-name="${t.item_name}" data-code="${t.serial_number || t.item_code}">${t.item_name} (${t.serial_number || t.item_code})</option>`);
        }
        async function populateRepairTools() {
            const select = document.getElementById('repair-tool-select');
            const { data: tools } = await supabase.from('tools').select('*');
            select.innerHTML = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ --</option>';
            if(tools) tools.forEach(t => select.innerHTML += `<option value="${t.id}" data-name="${t.item_name}" data-code="${t.serial_number || t.item_code}">${t.item_name} (${t.serial_number || t.item_code})</option>`);
        }
        
        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const select = document.getElementById('checkout-tool-select');
            const toolId = select.value;
            const selectedOption = select.options[select.selectedIndex];
            const toolName = selectedOption.dataset.name;
            const toolCode = selectedOption.dataset.code;
            const borrower = document.getElementById('borrower-name').value;
            const lender = document.getElementById('lender-name').value;

            // 1. Update tool status
            await supabase.from('tools').update({ status: '‡∏ñ‡∏π‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å' }).eq('id', toolId);
            // 2. Log transaction
            await supabase.from('transactions').insert({ tool_id: toolId, borrower_name: borrower, lender_name: lender });
            
            // 3. Open print page
            const url = `print-checkout.html?toolName=${encodeURIComponent(toolName)}&toolCode=${encodeURIComponent(toolCode)}&borrower=${encodeURIComponent(borrower)}&lender=${encodeURIComponent(lender)}`;
            window.open(url, '_blank');
            
            closeModal();
            refreshAllData();
        });

        document.getElementById('repair-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const select = document.getElementById('repair-tool-select');
            const toolId = select.value;
            const selectedOption = select.options[select.selectedIndex];
            const toolName = selectedOption.dataset.name;
            const toolCode = selectedOption.dataset.code;
            const reporter = document.getElementById('reporter-name').value;
            const problem = document.getElementById('problem-description').value;

            await supabase.from('tools').update({ status: '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á' }).eq('id', toolId);
            await supabase.from('maintenance_requests').insert({ tool_id: toolId, reporter_name: reporter, problem_description: problem });

            const url = `print-repair.html?toolName=${encodeURIComponent(toolName)}&toolCode=${encodeURIComponent(toolCode)}&reporter=${encodeURIComponent(reporter)}&problem=${encodeURIComponent(problem)}`;
            window.open(url, '_blank');
            
            closeModal();
            refreshAllData();
        });

        // --- Main Table (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á status) ---
        async function loadMainTable() {
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î query ‡πÄ‡∏î‡∏¥‡∏°)
            mainTableBody.innerHTML = '';
            if (data) {
                // ...
                data.forEach(tool => {
                    let statusColor = 'text-gray-500';
                    if (tool.status === '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô') statusColor = 'text-green-600';
                    if (tool.status === '‡∏ñ‡∏π‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å') statusColor = 'text-yellow-600';
                    if (tool.status === '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á') statusColor = 'text-red-600';

                    mainTableBody.innerHTML += `<tr>
                        <td class="p-3 font-bold ${statusColor}">${tool.status}</td>
                        <td class="p-3">${manageButtons}</td>
                    </tr>`;
                });
                // ...
            }
        }
        
        // --- (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    </script>
</body>
</html>
